# WeekNote 云端版本测试指南

本指南将帮助你一步一步启动服务并测试完整的云端多用户系统。

---

## 📋 测试前准备

### 1. 确认当前状态

确认以下内容已完成：
- ✅ 后端代码已编译（`packages/server/dist`）
- ✅ 前端代码已编译（`packages/cli/web-dist`）
- ✅ 所有依赖已安装（`node_modules`）

---

## 🗄️ 第一步：启动 MongoDB

### 方案 A：使用本地 MongoDB（推荐用于测试）

#### 1.1 安装 MongoDB（如果还没安装）

**macOS (使用 Homebrew)**:
```bash
brew tap mongodb/brew
brew install mongodb-community
```

**其他系统**:
- 访问 https://www.mongodb.com/try/download/community 下载

#### 1.2 启动 MongoDB

**macOS**:
```bash
# 启动 MongoDB 服务
brew services start mongodb-community

# 或者临时启动（不作为后台服务）
mongod --config /opt/homebrew/etc/mongod.conf
```

**验证 MongoDB 是否运行**:
```bash
# 尝试连接 MongoDB
mongosh

# 如果成功连接，会看到 MongoDB shell
# 输入 exit 退出
```

### 方案 B：使用 Docker（可选）

```bash
# 启动 MongoDB 容器
docker run -d \
  --name weeknote-mongo \
  -p 27017:27017 \
  -e MONGO_INITDB_DATABASE=weeknote \
  mongo:latest

# 查看容器状态
docker ps
```

---

## ⚙️ 第二步：配置环境变量

### 2.1 创建后端环境变量文件

在项目根目录创建 `.env` 文件：

```bash
cd /Users/starone/Desktop/StarOne-PC/self/weeknote
touch .env
```

### 2.2 编辑 `.env` 文件

使用任意编辑器打开 `.env`，添加以下内容：

```env
# MongoDB 连接字符串
MONGODB_URI=mongodb://localhost:27017/weeknote

# JWT 密钥（请修改为随机字符串）
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# 服务端口
PORT=3000
```

**⚠️ 重要提示**:
- `JWT_SECRET` 必须修改为一个随机字符串（至少 32 个字符）
- 生产环境千万不要使用默认值

**生成随机 JWT_SECRET**:
```bash
# macOS/Linux
openssl rand -base64 32

# 或使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

---

## 🚀 第三步：启动后端服务

### 3.1 安装依赖（如果有新增依赖）

```bash
cd /Users/starone/Desktop/StarOne-PC/self/weeknote

# 安装所有依赖
pnpm install
```

### 3.2 编译后端代码

```bash
# 编译后端
pnpm --filter @weeknote/server build
```

### 3.3 新建终端窗口启动后端

```bash
cd /Users/starone/Desktop/StarOne-PC/self/weeknote

# 启动云端后端服务（会自动加载 .env 文件）
pnpm --filter @weeknote/server start
```

**💡 提示**: 保持这个终端窗口打开，不要关闭。后端服务需要持续运行。

### 3.4 验证后端启动

你应该看到类似的输出：

```
[Server] 正在连接 MongoDB...
[Server] MongoDB 连接成功

============================================================
  WeekNote 云端服务已启动 🚀
============================================================

  服务地址:     http://localhost:3000
  Web UI:       http://localhost:3000
  健康检查:     http://localhost:3000/api/health

  MongoDB:      mongodb://localhost:27017/weeknote

============================================================
```

**测试后端健康状态**:

打开浏览器或使用 curl：
```bash
curl http://localhost:3000/api/health
```

应该返回：
```json
{
  "status": "ok",
  "message": "WeekNote API is running"
}
```

---

## 🌐 第四步：访问 Web 应用

### 4.1 打开浏览器

访问：http://localhost:3000

你应该会看到登录/注册页面。

---

## ✅ 第五步：测试功能

### 5.1 测试用户注册

1. 在登录页面点击"注册" Tab
2. 填写信息：
   - **邮箱**: `test@example.com`
   - **用户名**: `测试用户`
   - **密码**: `Test123456`（至少 6 个字符）
   - **确认密码**: `Test123456`
3. 点击"注册"按钮

**预期结果**:
- ✅ 显示"注册成功"提示
- ✅ 自动跳转到首页
- ✅ 右上角显示用户头像和名字

### 5.2 测试用户登录

1. 退出登录（点击右上角用户菜单 → 退出登录）
2. 在登录页面填写：
   - **邮箱**: `test@example.com`
   - **密码**: `Test123456`
3. 点击"登录"按钮

**预期结果**:
- ✅ 显示"登录成功"提示
- ✅ 自动跳转到首页

### 5.3 测试配置 API Key

1. 点击右上角"设置"按钮
2. 在"模型与 API Key"页面，选择一个平台（如 SiliconFlow）
3. 填写你的 API Key
4. 点击"保存"

**预期结果**:
- ✅ 显示"保存成功"
- ✅ API Key 显示为脱敏状态（`sk-****1234`）

### 5.4 测试每日记录

1. 点击顶部"每日记录"按钮
2. 选择今天的日期
3. 填写日志内容：
   ```
   Plan
   - 测试 WeekNote 系统
   - 完成登录注册功能
   
   Result
   - 成功注册新账号
   - 成功配置 API Key
   
   Issues
   
   Notes
   ```
4. 点击"保存"

**预期结果**:
- ✅ 显示"保存成功"
- ✅ 数据自动保存到云端（MongoDB）

### 5.5 测试周报生成

1. 回到首页
2. 在 Daily Log 输入框中输入本周的日志内容
3. 选择模型（需要先配置对应的 API Key）
4. 点击"🚀 生成周报"

**预期结果**:
- ✅ 显示生成中状态
- ✅ AI 开始流式输出周报内容
- ✅ 生成完成后显示"✓ 由 XXX 生成"
- ✅ 可以复制周报内容

### 5.6 测试 Token 自动刷新

1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签页
3. 在应用中进行任意操作（如保存日志）
4. 观察请求头中的 `Authorization: Bearer <token>`

**预期结果**:
- ✅ 所有请求自动带上 Token
- ✅ Token 过期后自动刷新（无需重新登录）

---

## 🔍 第六步：验证数据库

### 6.1 连接 MongoDB 查看数据

```bash
# 启动 MongoDB Shell
mongosh

# 切换到 weeknote 数据库
use weeknote

# 查看所有集合
show collections

# 查看用户数据
db.users.find().pretty()

# 查看每日记录
db.dailylogs.find().pretty()

# 查看生成历史
db.generationhistories.find().pretty()
```

**预期结果**:
- ✅ 可以看到刚才创建的用户记录
- ✅ 可以看到保存的每日记录
- ✅ 可以看到生成的周报历史

---

## 🐛 故障排查

### 问题 1: MongoDB 连接失败

**错误信息**:
```
[Server] MongoDB 连接失败: connect ECONNREFUSED 127.0.0.1:27017
```

**解决方法**:
1. 确认 MongoDB 是否运行：`brew services list | grep mongodb`
2. 重启 MongoDB：`brew services restart mongodb-community`
3. 检查防火墙是否阻止了 27017 端口

### 问题 2: JWT_SECRET 警告

**警告信息**:
```
[Warning] 使用默认 JWT_SECRET，请在生产环境中配置环境变量
```

**解决方法**:
- 在 `.env` 文件中设置 `JWT_SECRET`
- 重启后端服务

### 问题 3: 401 Unauthorized

**解决方法**:
1. 清除浏览器 localStorage：
   - 打开开发者工具 → Application → Local Storage
   - 删除 `accessToken` 和 `refreshToken`
2. 刷新页面重新登录

### 问题 4: 前端 API 调用失败

**检查项**:
1. 后端是否正常运行（访问 http://localhost:3000/api/health）
2. 浏览器控制台是否有 CORS 错误
3. Network 标签页查看具体的错误响应

---

## 📊 测试清单

完成以下所有测试项，确认系统正常运行：

### 基础功能
- [ ] MongoDB 成功启动
- [ ] 后端服务成功启动
- [ ] Web UI 可以访问
- [ ] 健康检查接口正常

### 用户认证
- [ ] 用户注册成功
- [ ] 用户登录成功
- [ ] 退出登录正常
- [ ] Token 自动刷新
- [ ] 401 自动跳转登录页

### 核心功能
- [ ] 保存 API Key 配置
- [ ] 保存每日记录
- [ ] 生成周报（AI 调用）
- [ ] 查看历史记录
- [ ] Prompt 模板管理

### 数据持久化
- [ ] 用户数据存入 MongoDB
- [ ] 每日记录存入 MongoDB
- [ ] 生成历史存入 MongoDB
- [ ] 数据查询正常

---

## 🎯 测试完成后

如果所有功能测试通过，说明系统运行正常！

### 下一步可以：
1. **优化体验**: 根据使用反馈调整 UI/UX
2. **性能测试**: 测试大量数据下的性能
3. **多用户测试**: 创建多个账号测试隔离性
4. **部署到云端**: 准备部署到火山引擎等云平台

---

## 📝 测试记录

建议在测试过程中记录：
- ✅ 成功的功能
- ❌ 发现的问题
- 💡 改进建议

**测试日期**: ___________

**测试人**: ___________

**测试结果**: [ ] 通过 / [ ] 部分通过 / [ ] 失败

**备注**:
___________________________________________
___________________________________________
___________________________________________
